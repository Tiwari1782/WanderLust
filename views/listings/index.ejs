<% layout("/layouts/boilerplate") %>


<% if (success && success.length) { %>
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div class="toast-card error" role="alert">
      <svg class="wave" viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M0,256L11.4,240C22.9,224,46,192,69,192C91.4,192,114,224,137,234.7C160,245,183,235,206,213.3C228.6,192,251,160,274,149.3C297.1,139,320,149,343,181.3C365.7,213,389,267,411,282.7C434.3,299,457,277,480,250.7C502.9,224,526,192,549,181.3C571.4,171,594,181,617,208C640,235,663,277,686,256C708.6,235,731,149,754,122.7C777.1,96,800,128,823,165.3C845.7,203,869,245,891,224C914.3,203,937,117,960,112C982.9,107,1006,181,1029,197.3C1051.4,213,1074,171,1097,144C1120,117,1143,107,1166,133.3C1188.6,160,1211,224,1234,218.7C1257.1,213,1280,139,1303,133.3C1325.7,128,1349,192,1371,192C1394.3,192,1417,128,1429,96L1440,64L1440,320L1428.6,320C1417.1,320,1394,320,1371,320C1348.6,320,1326,320,1303,320C1280,320,1257,320,1234,320C1211.4,320,1189,320,1166,320C1142.9,320,1120,320,1097,320C1074.3,320,1051,320,1029,320C1005.7,320,983,320,960,320C937.1,320,914,320,891,320C868.6,320,846,320,823,320C800,320,777,320,754,320C731.4,320,709,320,686,320C662.9,320,640,320,617,320C594.3,320,571,320,549,320C525.7,320,503,320,480,320C457.1,320,434,320,411,320C388.6,320,366,320,343,320C320,320,297,320,274,320C251.4,320,229,320,206,320C182.9,320,160,320,137,320C114.3,320,91,320,69,320C45.7,320,23,320,11,320L0,320Z"
          fill-opacity="1"
        ></path>
      </svg>

      <div class="icon-container">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon">
          <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
        </svg>
      </div>

      <div class="message-text-container">
        <p class="message-text">Success!</p>
        <p class="sub-text"><%= success[0] %></p>
      </div>

      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 15 15"
        fill="currentColor"
        class="cross-icon"
        onclick="this.closest('.toast-card').style.display='none'"
      >
        <path
          d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.49999L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.49999L11.7816 4.03157Z"
          clip-rule="evenodd"
          fill-rule="evenodd"
        ></path>
      </svg>
    </div>
  </div>
<% } %>

<!-- Error Toast Notification -->
<% if (error && error.length) { %>
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div class="toast-card error" role="alert">
      <svg class="wave" viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M0,256L11.4,240C22.9,224,46,192,69,192C91.4,192,114,224,137,234.7C160,245,183,235,206,213.3C228.6,192,251,160,274,149.3C297.1,139,320,149,343,181.3C365.7,213,389,267,411,282.7C434.3,299,457,277,480,250.7C502.9,224,526,192,549,181.3C571.4,171,594,181,617,208C640,235,663,277,686,256C708.6,235,731,149,754,122.7C777.1,96,800,128,823,165.3C845.7,203,869,245,891,224C914.3,203,937,117,960,112C982.9,107,1006,181,1029,197.3C1051.4,213,1074,171,1097,144C1120,117,1143,107,1166,133.3C1188.6,160,1211,224,1234,218.7C1257.1,213,1280,139,1303,133.3C1325.7,128,1349,192,1371,192C1394.3,192,1417,128,1429,96L1440,64L1440,320L1428.6,320C1417.1,320,1394,320,1371,320C1348.6,320,1326,320,1303,320C1280,320,1257,320,1234,320C1211.4,320,1189,320,1166,320C1142.9,320,1120,320,1097,320C1074.3,320,1051,320,1029,320C1005.7,320,983,320,960,320C937.1,320,914,320,891,320C868.6,320,846,320,823,320C800,320,777,320,754,320C731.4,320,709,320,686,320C662.9,320,640,320,617,320C594.3,320,571,320,549,320C525.7,320,503,320,480,320C457.1,320,434,320,411,320C388.6,320,366,320,343,320C320,320,297,320,274,320C251.4,320,229,320,206,320C182.9,320,160,320,137,320C114.3,320,91,320,69,320C45.7,320,23,320,11,320L0,320Z"
          fill-opacity="1"
        ></path>
      </svg>

      <div class="icon-container">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon">
          <path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
        </svg>
      </div>

      <div class="message-text-container">
        <p class="message-text">Error!</p>
        <p class="sub-text"><%= error[0] %></p>
      </div>

      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 15 15"
        fill="currentColor"
        class="cross-icon"
        onclick="this.closest('.toast-card').style.display='none'"
      >
        <path
          d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.49999L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.49999L11.7816 4.03157Z"
          clip-rule="evenodd"
          fill-rule="evenodd"
        ></path>
      </svg>
    </div>
  </div>
<% } %>


<style>
  

</style>

<!-- Filters and Toggle Wrapper -->
<div class="filters-and-toggle-wrapper">
  <!-- Filters Section -->
  <div id="filters">
    <a href="/listings" class="filter-link">
      <div class="filter <%= typeof selectedCategory === 'undefined' ? 'active' : '' %>">
        <i class="fa-solid fa-border-all"></i>
        <p>All</p>
      </div>
    </a>
    <a href="/listings/filter/Trending" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Trending' ? 'active' : '' %>">
        <i class="fa-solid fa-fire"></i>
        <p>Trending</p>
      </div>
    </a>
    <a href="/listings/filter/Rooms" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Rooms' ? 'active' : '' %>">
        <i class="fa-solid fa-bed"></i>
        <p>Rooms</p>
      </div>
    </a>
    <a href="/listings/filter/Iconic Cities" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Iconic Cities' ? 'active' : '' %>">
        <i class="fa-solid fa-mountain-city"></i>
        <p>Iconic Cities</p>
      </div>
    </a>
    <a href="/listings/filter/Mountains" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Mountains' ? 'active' : '' %>">
        <i class="fa-solid fa-mountain"></i>
        <p>Mountains</p>
      </div>
    </a>
    <a href="/listings/filter/Beach" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Beach' ? 'active' : '' %>">
        <i class="fa-solid fa-umbrella-beach"></i>
        <p>Beach</p>
      </div>
    </a>
    <a href="/listings/filter/Amazing Pools" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Amazing Pools' ? 'active' : '' %>">
        <i class="fa-solid fa-person-swimming"></i>
        <p>Amazing Pools</p>
      </div>
    </a>
    <a href="/listings/filter/Cabins" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Cabins' ? 'active' : '' %>">
        <i class="fa-solid fa-cable-car"></i>
        <p>Cabins</p>
      </div>
    </a>
    <a href="/listings/filter/Dining" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Dining' ? 'active' : '' %>">
        <i class="fa-solid fa-mug-saucer"></i>
        <p>Dining</p>
      </div>
    </a>
    <a href="/listings/filter/Lakefront" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Lakefront' ? 'active' : '' %>">
        <i class="fa-solid fa-water"></i>
        <p>Lakefront</p>
      </div>
    </a>
    <a href="/listings/filter/Countryside" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Countryside' ? 'active' : '' %>">
        <i class="fa-solid fa-tree"></i>
        <p>Countryside</p>
      </div>
    </a>
    <a href="/listings/filter/Castles" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Castles' ? 'active' : '' %>">
        <i class="fa-solid fa-chess-rook"></i>
        <p>Castles</p>
      </div>
    </a>
    <a href="/listings/filter/Camping" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Camping' ? 'active' : '' %>">
        <i class="fa-solid fa-campground"></i>
        <p>Camping</p>
      </div>
    </a>
    <a href="/listings/filter/Arctic" class="filter-link">
      <div class="filter <%= typeof selectedCategory !== 'undefined' && selectedCategory === 'Arctic' ? 'active' : '' %>">
        <i class="fa-solid fa-snowflake"></i>
        <p>Arctic</p>
      </div>
    </a>
  </div>

  <!-- Right Controls (Sort + Tax Toggle) -->
  <div class="right-controls">
    <!-- Sort Dropdown -->
    <div class="sort-dropdown-wrapper">
      <div class="sort-btn" id="sortBtn">
        <i class="fa-solid fa-arrow-down-short-wide sort-icon"></i>
        <span class="sort-text" id="sortText">Sort</span>
        <i class="fa-solid fa-chevron-down sort-arrow"></i>
      </div>
      
      <div class="sort-dropdown-menu" id="sortDropdown">
        <a href="?sort=default<%= typeof selectedCategory !== 'undefined' ? '&category=' + selectedCategory : '' %>" class="sort-option <%= !sort || sort === 'default' ? 'active' : '' %>">
          <i class="fa-solid fa-star sort-option-icon"></i>
          <span class="sort-option-text">Featured</span>
          <i class="fa-solid fa-check sort-option-check"></i>
        </a>
        <a href="?sort=price-low<%= typeof selectedCategory !== 'undefined' ? '&category=' + selectedCategory : '' %>" class="sort-option <%= sort === 'price-low' ? 'active' : '' %>">
          <i class="fa-solid fa-arrow-down-1-9 sort-option-icon"></i>
          <span class="sort-option-text">Price: Low to High</span>
          <i class="fa-solid fa-check sort-option-check"></i>
        </a>
        <a href="?sort=price-high<%= typeof selectedCategory !== 'undefined' ? '&category=' + selectedCategory : '' %>" class="sort-option <%= sort === 'price-high' ? 'active' : '' %>">
          <i class="fa-solid fa-arrow-up-9-1 sort-option-icon"></i>
          <span class="sort-option-text">Price: High to Low</span>
          <i class="fa-solid fa-check sort-option-check"></i>
        </a>
        <a href="?sort=newest<%= typeof selectedCategory !== 'undefined' ? '&category=' + selectedCategory : '' %>" class="sort-option <%= sort === 'newest' ? 'active' : '' %>">
          <i class="fa-solid fa-clock sort-option-icon"></i>
          <span class="sort-option-text">Newest First</span>
          <i class="fa-solid fa-check sort-option-check"></i>
        </a>
      </div>
    </div>

    <!-- Tax Toggle Button -->
    <div class="tax-toggle-btn" id="taxToggleBtn">
      <i class="fa-solid fa-sliders tax-toggle-icon"></i>
      <span class="tax-toggle-text">Display total before taxes</span>
      <div class="tax-toggle-switch">
        <div class="tax-toggle-switch-circle"></div>
      </div>
    </div>
  </div>
</div>

<!-- Listings Grid -->
<div class="listings-container">
  <% if (allListings.length === 0) { %>
    <div class="no-results">
      <i class="fa-solid fa-circle-exclamation"></i>
      <h3>No listings found</h3>
      <p>Try selecting a different category or view all listings</p>
      <a href="/listings" class="btn btn-primary-custom">
        <i class="fa-solid fa-arrow-left"></i>
        View All Listings
      </a>
    </div>
  <% } else { %>
    <div class="listings-grid">
      <% for (let listing of allListings) { %>
        <a href="/listings/<%= listing._id %>" class="listing-card-wrapper">
          <div class="listing-card">
            <div class="listing-image-container">
              <img
                src="<%= listing.image.url %>"
                class="listing-card-img"
                alt="<%= listing.title %>"
              >
            </div>
            <div class="listing-card-body">
              <h3 class="listing-location"><%= listing.location %>, <%= listing.country %></h3>
              <p class="listing-title-text"><%= listing.title %></p>
              <div class="listing-price-wrapper">
                <span class="listing-price" data-original-price="<%= listing.price %>">
                  ₹<%= listing.price.toLocaleString("en-IN") %>
                </span>
                <span class="listing-price-label">night</span>
              </div>
            </div>
          </div>
        </a>
      <% } %>
    </div>
  <% } %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Auto-hide toasts after 5 seconds
    const toasts = document.querySelectorAll('.toast-card');
    toasts.forEach(toast => {
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        toast.style.transition = 'all 0.4s ease-out';
        setTimeout(() => {
          toast.style.display = 'none';
        }, 400);
      }, 5000);
    });

    // Sort Dropdown Toggle
    const sortBtn = document.getElementById('sortBtn');
    const sortDropdown = document.getElementById('sortDropdown');
    
    sortBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      sortBtn.classList.toggle('active');
      sortDropdown.classList.toggle('show');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!sortBtn.contains(e.target) && !sortDropdown.contains(e.target)) {
        sortBtn.classList.remove('active');
        sortDropdown.classList.remove('show');
      }
    });

    // Tax Toggle Functionality
    const taxToggleBtn = document.getElementById('taxToggleBtn');
    const priceElements = document.querySelectorAll('.listing-price');

    // Load saved preference
    const taxEnabled = localStorage.getItem('showTaxes') === 'true';
    if (taxEnabled) {
      taxToggleBtn.classList.add('active');
      updatePrices(true);
    }

    // Toggle click event
    taxToggleBtn.addEventListener('click', function() {
      const isActive = this.classList.toggle('active');
      localStorage.setItem('showTaxes', isActive);
      updatePrices(isActive);
    });

    // Update price display
    function updatePrices(showTax) {
      priceElements.forEach(priceEl => {
        const originalPrice = parseInt(priceEl.getAttribute('data-original-price'));
        if (showTax) {
          const taxAmount = Math.round(originalPrice * 0.18);
          const totalPrice = originalPrice + taxAmount;
          priceEl.textContent = '₹' + totalPrice.toLocaleString('en-IN');
        } else {
          priceEl.textContent = '₹' + originalPrice.toLocaleString('en-IN');
        }
      });
    }
  });
</script>
