<% layout("/layouts/boilerplate") %>

<!-- Success Toast Notification (Red) -->
<% if (success && success.length) { %>
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div class="toast-card error" role="alert">
      <svg class="wave" viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M0,256L11.4,240C22.9,224,46,192,69,192C91.4,192,114,224,137,234.7C160,245,183,235,206,213.3C228.6,192,251,160,274,149.3C297.1,139,320,149,343,181.3C365.7,213,389,267,411,282.7C434.3,299,457,277,480,250.7C502.9,224,526,192,549,181.3C571.4,171,594,181,617,208C640,235,663,277,686,256C708.6,235,731,149,754,122.7C777.1,96,800,128,823,165.3C845.7,203,869,245,891,224C914.3,203,937,117,960,112C982.9,107,1006,181,1029,197.3C1051.4,213,1074,171,1097,144C1120,117,1143,107,1166,133.3C1188.6,160,1211,224,1234,218.7C1257.1,213,1280,139,1303,133.3C1325.7,128,1349,192,1371,192C1394.3,192,1417,128,1429,96L1440,64L1440,320L1428.6,320C1417.1,320,1394,320,1371,320C1348.6,320,1326,320,1303,320C1280,320,1257,320,1234,320C1211.4,320,1189,320,1166,320C1142.9,320,1120,320,1097,320C1074.3,320,1051,320,1029,320C1005.7,320,983,320,960,320C937.1,320,914,320,891,320C868.6,320,846,320,823,320C800,320,777,320,754,320C731.4,320,709,320,686,320C662.9,320,640,320,617,320C594.3,320,571,320,549,320C525.7,320,503,320,480,320C457.1,320,434,320,411,320C388.6,320,366,320,343,320C320,320,297,320,274,320C251.4,320,229,320,206,320C182.9,320,160,320,137,320C114.3,320,91,320,69,320C45.7,320,23,320,11,320L0,320Z"
          fill-opacity="1"
        ></path>
      </svg>

      <div class="icon-container">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon">
          <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
        </svg>
      </div>

      <div class="message-text-container">
        <p class="message-text">Success!</p>
        <p class="sub-text"><%= success[0] %></p>
      </div>

      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 15 15"
        fill="currentColor"
        class="cross-icon"
        onclick="this.closest('.toast-card').style.display='none'"
      >
        <path
          d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.49999L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.49999L11.7816 4.03157Z"
          clip-rule="evenodd"
          fill-rule="evenodd"
        ></path>
      </svg>
    </div>
  </div>
<% } %>

<!-- Error Toast Notification (Red) -->
<% if (error && error.length) { %>
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div class="toast-card error" role="alert">
      <svg class="wave" viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M0,256L11.4,240C22.9,224,46,192,69,192C91.4,192,114,224,137,234.7C160,245,183,235,206,213.3C228.6,192,251,160,274,149.3C297.1,139,320,149,343,181.3C365.7,213,389,267,411,282.7C434.3,299,457,277,480,250.7C502.9,224,526,192,549,181.3C571.4,171,594,181,617,208C640,235,663,277,686,256C708.6,235,731,149,754,122.7C777.1,96,800,128,823,165.3C845.7,203,869,245,891,224C914.3,203,937,117,960,112C982.9,107,1006,181,1029,197.3C1051.4,213,1074,171,1097,144C1120,117,1143,107,1166,133.3C1188.6,160,1211,224,1234,218.7C1257.1,213,1280,139,1303,133.3C1325.7,128,1349,192,1371,192C1394.3,192,1417,128,1429,96L1440,64L1440,320L1428.6,320C1417.1,320,1394,320,1371,320C1348.6,320,1326,320,1303,320C1280,320,1257,320,1234,320C1211.4,320,1189,320,1166,320C1142.9,320,1120,320,1097,320C1074.3,320,1051,320,1029,320C1005.7,320,983,320,960,320C937.1,320,914,320,891,320C868.6,320,846,320,823,320C800,320,777,320,754,320C731.4,320,709,320,686,320C662.9,320,640,320,617,320C594.3,320,571,320,549,320C525.7,320,503,320,480,320C457.1,320,434,320,411,320C388.6,320,366,320,343,320C320,320,297,320,274,320C251.4,320,229,320,206,320C182.9,320,160,320,137,320C114.3,320,91,320,69,320C45.7,320,23,320,11,320L0,320Z"
          fill-opacity="1"
        ></path>
      </svg>

      <div class="icon-container">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon">
          <path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
        </svg>
      </div>

      <div class="message-text-container">
        <p class="message-text">Error!</p>
        <p class="sub-text"><%= error[0] %></p>
      </div>

      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 15 15"
        fill="currentColor"
        class="cross-icon"
        onclick="this.closest('.toast-card').style.display='none'"
      >
        <path
          d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.49999L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.49999L11.7816 4.03157Z"
          clip-rule="evenodd"
          fill-rule="evenodd"
        ></path>
      </svg>
    </div>
  </div>
<% } %>

<!-- Delete Confirmation Modal -->
<div class="delete-modal" id="deleteModal">
  <div class="delete-modal-overlay" onclick="closeDeleteModal()"></div>
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <div class="delete-modal-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3 class="delete-modal-title">Delete Listing?</h3>
      <p class="delete-modal-subtitle">Are you sure you want to delete this listing? This action cannot be undone.</p>
    </div>
    <div class="delete-modal-body">
      <p class="delete-modal-warning">
        <i class="fas fa-info-circle"></i>
        All reviews and data associated with this listing will be permanently deleted.
      </p>
    </div>
    <div class="delete-modal-footer">
      <button type="button" class="btn-modal-cancel" onclick="closeDeleteModal()">
        <i class="fas fa-times"></i>
        Cancel
      </button>
      <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" id="deleteForm" style="display: inline;">
        <button type="submit" class="btn-modal-delete">
          <i class="fas fa-trash-alt"></i>
          Delete Listing
        </button>
      </form>
    </div>
  </div>
</div>

<div class="container">
  <div class="row mt-4">
    <!-- Back Navigation -->
    <div class="col-12 col-md-10 offset-md-1 col-lg-8 offset-lg-2 mb-3">
      <a href="/listings" class="back-link">
        <i class="fas fa-arrow-left"></i> Back to Listings
      </a>
    </div>

    <!-- Listing Card -->
    <div class="col-12 col-md-10 offset-md-1 col-lg-8 offset-lg-2">
      <div class="show-card">
        <img
          src="<%= listing.image %>"
          class="show-img"
          alt="<%= listing.title %>"
        />
        <div class="show-card-body">
          <h2 class="listing-title"><i class="fa-solid fa-map-pin"></i> <%= listing.title %></h2>
          <p class="listing-description">
            <i class="fa-solid fa-crown"></i><b> Owned By : </b><i><%= listing.owner.username %></i>
            <br>
            <%= listing.description %>
          </p>
          <div class="listing-details">
            <div class="detail-item">
              <i class="fas fa-rupee-sign"></i>
              <span class="price"
                >â‚¹<%= listing.price.toLocaleString("en-IN") %></span
              >
              <span class="price-label">per night</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-map-marker-alt"></i>
              <span><%= listing.location %>, <%= listing.country %></span>
            </div>
          </div>

          <% if(currUser && listing.owner._id.equals(currUser._id)) {%>
          <!-- Action Buttons -->
          <div class="action-buttons">
            <a
              href="/listings/<%= listing._id %>/edit"
              class="btn btn-primary-custom"
            >
              <i class="fas fa-edit"></i> Edit
            </a>
            <button class="btn btn-delete" type="button" onclick="openDeleteModal()">
              <i class="fas fa-trash-alt"></i> Delete
            </button>
          </div>
          <% } %>
          <% if(currUser) { %>
          <!-- Review Section -->
          <div class="review-section">
            <h4 class="review-heading"><i class="fa-solid fa-pen-to-square"></i> Leave a Review</h4>
            <form
              novalidate
              class="needs-validation"
              action="/listings/<%= listing._id %>/reviews"
              method="POST"
              class="review-form"
            >
              <div class="form-group">
                <label class="form-label" for="rating">
                  <i class="fas fa-star"></i> Rating
                </label>
                <div class="rating-container">
                  <input
                    type="range"
                    min="1"
                    max="5"
                    id="rating"
                    name="review[rating]"
                    class="form-range"
                    value="3"
                  />
                  <span class="rating-value" id="ratingValue">3</span>
                </div>
              </div>
              <br>
              <div class="form-group">
                <label for="comment" class="form-label">
                  <i class="fas fa-comment-dots"></i> Comment
                </label>
                <textarea
                  name="review[comment]"
                  id="comment"
                  rows="5"
                  class="form-control"
                  placeholder="Share your experience..."
                  required
                ></textarea>
                <div class="invalid-feedback">Please add some comments for review</div>
                <div class="valid-feedback">Comments Looks Good</div>
              </div>
              <br>
              <button type="submit" class="btn btn-submit-review">
                <i class="fas fa-paper-plane"></i> Submit Review
              </button>
            </form>
            <% } %>
            <hr>
          <!-- Reviews Display Section -->
          <% if(listing.reviews && listing.reviews.length > 0) { %>
          <hr style="margin: 2.5rem 0 2rem 0; border-color: #e0e0e0;">
          
          <div class="reviews-container">
            <h4 class="reviews-title">
              <i class="fas fa-star" style="color: #fe424d;"></i> 
              Reviews (<%= listing.reviews.length %>)
            </h4>
            
            <div class="row">
              <% for(let review of listing.reviews) { %>
                <div class="col-12 col-md-6 mb-3">
                  <div class="review-card">
                    <div class="review-card-header">
                      <div class="reviewer-avatar">
                        <i class="fas fa-user"></i>
                      </div>
                      <div class="reviewer-info">
                        <h6 class="reviewer-name">@<%= review.author.username %></h6>
                        <div class="review-rating">
                          <% for(let i = 1; i <= 5; i++) { %>
                            <% if(i <= review.rating) { %>
                              <i class="fas fa-star filled-star"></i>
                            <% } else { %>
                              <i class="far fa-star empty-star"></i>
                            <% } %>
                          <% } %>
                          <span class="rating-number"><%= review.rating %>/5</span>
                        </div>
                      </div>
                    </div>
                    <p class="review-comment"><%= review.comment %></p>
                    <div class="review-footer">
                      <small class="review-date">
                        <i class="far fa-clock"></i><%= new Date(review.createdAt).toLocaleDateString("en-GB") %>
                      </small>
                      <% if(currUser && review.author._id.equals(currUser._id)) { %>
                      <button type="button" class="btn-delete-review" onclick="openDeleteReviewModal('<%= listing._id %>', '<%= review._id %>')">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                      <% } %>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          </div>
          <% } else { %>
          <hr style="margin: 2.5rem 0 2rem 0; border-color: #e0e0e0;">
          <div class="no-reviews">
            <i class="far fa-comment-dots"></i>
            <p>No reviews yet. Be the first to review!</p>
          </div>
          <% } %>
          
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Review Modal -->
<div class="delete-modal" id="deleteReviewModal">
  <div class="delete-modal-overlay" onclick="closeDeleteReviewModal()"></div>
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <div class="delete-modal-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3 class="delete-modal-title">Delete Review?</h3>
      <p class="delete-modal-subtitle">Are you sure you want to delete this review?</p>
    </div>
    <div class="delete-modal-footer">
      <button type="button" class="btn-modal-cancel" onclick="closeDeleteReviewModal()">
        <i class="fas fa-times"></i>
        Cancel
      </button>
      <form method="POST" action="" id="deleteReviewForm" style="display: inline;">
        <button type="submit" class="btn-modal-delete">
          <i class="fas fa-trash-alt"></i>
          Delete Review
        </button>
      </form>
    </div>
  </div>
</div>

<style>
/* Delete Modal Styles */
.delete-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

.delete-modal.active {
  display: flex;
}

.delete-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  animation: fadeIn 0.3s ease;
}

.delete-modal-content {
  position: relative;
  background-color: #ffffff;
  border-radius: 1.25rem;
  max-width: 480px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.3s ease;
  overflow: hidden;
}

.delete-modal-header {
  padding: 2rem 2rem 1.5rem;
  text-align: center;
  background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
  border-bottom: 1px solid #f0f0f0;
}

.delete-modal-icon {
  width: 70px;
  height: 70px;
  margin: 0 auto 1.25rem;
  background: linear-gradient(135deg, #ff6b6b 0%, #fe424d 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: pulse 2s infinite;
}

.delete-modal-icon i {
  font-size: 2rem;
  color: #ffffff;
}

.delete-modal-title {
  font-size: 1.75rem;
  font-weight: 700;
  color: #111111;
  margin-bottom: 0.5rem;
}

.delete-modal-subtitle {
  font-size: 1rem;
  color: #666666;
  margin: 0;
  line-height: 1.6;
}

.delete-modal-body {
  padding: 1.5rem 2rem;
}

.delete-modal-warning {
  background-color: #fff8f0;
  border-left: 4px solid #ff9800;
  padding: 1rem 1.25rem;
  border-radius: 0.5rem;
  color: #666666;
  font-size: 0.95rem;
  margin: 0;
  line-height: 1.6;
}

.delete-modal-warning i {
  color: #ff9800;
  margin-right: 0.5rem;
}

.delete-modal-footer {
  padding: 1.5rem 2rem 2rem;
  display: flex;
  gap: 1rem;
  justify-content: center;
}

.btn-modal-cancel,
.btn-modal-delete {
  padding: 0.75rem 1.75rem;
  font-weight: 600;
  font-size: 1rem;
  border-radius: 0.5rem;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-modal-cancel {
  background-color: #f5f5f5;
  color: #111111;
  border: 2px solid #e0e0e0;
}

.btn-modal-cancel:hover {
  background-color: #e0e0e0;
  transform: translateY(-2px);
}

.btn-modal-delete {
  background-color: #fe424d;
  color: #ffffff;
  border: 2px solid #fe424d;
}

.btn-modal-delete:hover {
  background-color: #e63946;
  border-color: #e63946;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(254, 66, 77, 0.4);
}

/* Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

/* Responsive */
@media (max-width: 576px) {
  .delete-modal-content {
    width: 95%;
    margin: 1rem;
  }

  .delete-modal-header {
    padding: 1.5rem 1.5rem 1.25rem;
  }

  .delete-modal-icon {
    width: 60px;
    height: 60px;
    margin-bottom: 1rem;
  }

  .delete-modal-icon i {
    font-size: 1.75rem;
  }

  .delete-modal-title {
    font-size: 1.5rem;
  }

  .delete-modal-subtitle {
    font-size: 0.95rem;
  }

  .delete-modal-body {
    padding: 1.25rem 1.5rem;
  }

  .delete-modal-footer {
    flex-direction: column;
    padding: 1.25rem 1.5rem 1.5rem;
  }

  .btn-modal-cancel,
  .btn-modal-delete {
    width: 100%;
    justify-content: center;
  }
}
</style>

<script>
  // Delete Listing Modal Functions
  function openDeleteModal() {
    document.getElementById('deleteModal').classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
    document.body.style.overflow = 'auto';
  }

  // Delete Review Modal Functions
  function openDeleteReviewModal(listingId, reviewId) {
    const form = document.getElementById('deleteReviewForm');
    form.action = `/listings/${listingId}/reviews/${reviewId}?_method=DELETE`;
    document.getElementById('deleteReviewModal').classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeDeleteReviewModal() {
    document.getElementById('deleteReviewModal').classList.remove('active');
    document.body.style.overflow = 'auto';
  }

  // Close modals on Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeDeleteModal();
      closeDeleteReviewModal();
    }
  });

  // Rating slider value display and dynamic fill
  const ratingSlider = document.getElementById("rating");
  const ratingValue = document.getElementById("ratingValue");

  function updateRating() {
    const value = ratingSlider.value;
    ratingValue.textContent = value;

    // Calculate percentage (1-5 scale)
    const percentage = ((value - 1) / 4) * 100;

    // Update background gradient dynamically
    ratingSlider.style.background = `linear-gradient(to right, #fe424d 0%, #fe424d ${percentage}%, #ddd ${percentage}%, #ddd 100%)`;
  }

  // Initialize on page load
  updateRating();

  // Update on slider change
  ratingSlider.addEventListener("input", updateRating);

  // Auto-hide toasts after 5 seconds
  document.addEventListener('DOMContentLoaded', function() {
    const toasts = document.querySelectorAll('.toast-card');
    toasts.forEach(toast => {
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        toast.style.transition = 'all 0.4s ease-out';
        setTimeout(() => {
          toast.style.display = 'none';
        }, 400);
      }, 5000);
    });
  });
</script>