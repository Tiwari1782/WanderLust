<% layout("/layouts/boilerplate") %>

<div class="row">
  <div class="col-10 offset-1 col-lg-8 offset-lg-2">
    <div class="form-page-container">
      <!-- Header -->
      <div class="form-page-header">
        <div class="form-page-icon">
          <i class="fa-solid fa-pen-to-square"></i>
        </div>
        <h1 class="form-page-title">Edit Your Listing</h1>
      </div>

      <!-- Form -->
      <form
        method="POST"
        action="/listings/<%= listing._id %>?_method=PUT"
        novalidate
        class="needs-validation"
        enctype="multipart/form-data"
      >
        <!-- Title -->
        <div class="form-input-group">
          <label for="title" class="form-input-label">
            <i class="fa-solid fa-heading"></i>
            Title
          </label>
          <input
            class="form-control form-input"
            type="text"
            name="listing[title]"
            value="<%= listing.title %>"
            placeholder="Enter a catchy title"
            required
          />
          <div class="invalid-feedback">Please enter a title</div>
          <div class="valid-feedback">Title looks good!</div>
        </div>

        <!-- Description -->
        <div class="form-input-group">
          <label for="description" class="form-input-label">
            <i class="fa-solid fa-align-left"></i>
            Description
          </label>
          <textarea
            class="form-control form-textarea"
            name="listing[description]"
            placeholder="Describe your listing in detail..."
            required
          ><%= listing.description %></textarea>
          <div class="invalid-feedback">Please enter a description</div>
          <div class="valid-feedback">Description looks good!</div>
        </div>

        <!-- Current Image Preview -->
        <div class="form-input-group">
          <label class="form-input-label">
            <i class="fa-solid fa-image"></i>
            Current Image
          </label>
          <div class="current-image-preview">
            <img src="<%= listing.image.url %>" alt="<%= listing.title %>" class="current-listing-image">
            <p class="current-image-label">
              <i class="fa-solid fa-circle-check"></i>
              Current listing image
            </p>
          </div>
        </div>

        <!-- Image Upload -->
        <div class="form-input-group">
          <label for="image" class="form-input-label">
            <i class="fa-solid fa-cloud-arrow-up"></i>
            Upload New Image (Optional)
          </label>
          
          <!-- Cloud Upload Area -->
          <div class="cloud-upload-container" id="cloudUploadEdit">
            <input
              class="cloud-upload-input"
              type="file"
              name="listing[image]"
              id="fileInputEdit"
              accept="image/png, image/jpeg, image/jpg"
            />
            
            <div class="cloud-upload-content">
              <div class="cloud-icon-wrapper">
                <i class="fa-solid fa-cloud-arrow-up cloud-icon"></i>
              </div>
              
              <h3 class="cloud-upload-title">Drop your new image here, or <span class="browse-text">browse</span></h3>
              <p class="cloud-upload-subtitle">Supports: PNG, JPG, JPEG (Max 5MB)</p>
              
              <div class="upload-button-wrapper">
                <button type="button" class="btn-upload-trigger" onclick="document.getElementById('fileInputEdit').click()">
                  <i class="fa-solid fa-folder-open"></i>
                  Choose File
                </button>
              </div>
            </div>
            
            <!-- File Preview -->
            <div class="file-preview" id="filePreviewEdit" style="display: none;">
              <div class="preview-image-wrapper">
                <img src="" alt="Preview" id="previewImageEdit" class="preview-image">
                <button type="button" class="btn-remove-file" onclick="removeFileEdit()">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
              <div class="file-info">
                <p class="file-name" id="fileNameEdit"></p>
                <p class="file-size" id="fileSizeEdit"></p>
              </div>
            </div>
          </div>
          
          <div class="form-helper-text">
            <i class="fa-solid fa-circle-info"></i>
            Leave empty to keep the current image
          </div>
          <div class="invalid-feedback">Please upload a valid PNG, JPG, or JPEG file</div>
          <div class="valid-feedback">Image looks good!</div>
        </div>

        <!-- Price & Country Row -->
        <div class="form-row-custom">
          <!-- Price -->
          <div class="form-input-group">
            <label for="price" class="form-input-label">
              <i class="fa-solid fa-indian-rupee-sign"></i>
              Price
            </label>
            <div class="price-input-wrapper">
              <input
                class="form-control form-input"
                name="listing[price]"
                type="number"
                value="<%= listing.price %>"
                placeholder="1200"
                required
              />
            </div>
            <div class="invalid-feedback">Please enter a valid price</div>
            <div class="valid-feedback">Price looks good!</div>
          </div>

          <!-- Country -->
          <div class="form-input-group">
            <label for="country" class="form-input-label">
              <i class="fa-solid fa-earth-americas"></i>
              Country
            </label>
            <input
              class="form-control form-input"
              name="listing[country]"
              type="text"
              value="<%= listing.country %>"
              placeholder="e.g., India"
              required
            />
            <div class="invalid-feedback">Please enter a country</div>
            <div class="valid-feedback">Country looks good!</div>
          </div>
        </div>

        <!-- Location -->
        <div class="form-input-group">
          <label for="location" class="form-input-label">
            <i class="fa-solid fa-location-dot"></i>
            Location
          </label>
          <input
            class="form-control form-input"
            name="listing[location]"
            type="text"
            value="<%= listing.location %>"
            placeholder="e.g., Mumbai, Maharashtra"
            required
          />
          <div class="invalid-feedback">Please enter a location</div>
          <div class="valid-feedback">Location looks good!</div>
        </div>

        <!-- Submit Area -->
        <div class="form-submit-area">
          <button type="submit" class="btn btn-submit-form">
            <i class="fa-solid fa-floppy-disk"></i>
            Save Changes
          </button>
          <button
            type="button"
            class="btn btn-delete"
            onclick="window.location.href = '/listings/<%= listing._id %>'"
          >
            <i class="fa-solid fa-xmark"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // File Upload Functionality for Edit Page
  const cloudUploadEdit = document.getElementById('cloudUploadEdit');
  const fileInputEdit = document.getElementById('fileInputEdit');
  const filePreviewEdit = document.getElementById('filePreviewEdit');
  const previewImageEdit = document.getElementById('previewImageEdit');
  const fileNameEdit = document.getElementById('fileNameEdit');
  const fileSizeEdit = document.getElementById('fileSizeEdit');

  // Drag and Drop Events
  cloudUploadEdit.addEventListener('dragover', (e) => {
    e.preventDefault();
    cloudUploadEdit.classList.add('drag-over');
  });

  cloudUploadEdit.addEventListener('dragleave', () => {
    cloudUploadEdit.classList.remove('drag-over');
  });

  cloudUploadEdit.addEventListener('drop', (e) => {
    e.preventDefault();
    cloudUploadEdit.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInputEdit.files = files;
      handleFileSelectEdit(files[0]);
    }
  });

  // File Input Change
  fileInputEdit.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      handleFileSelectEdit(file);
    }
  });

  // Handle File Selection
  function handleFileSelectEdit(file) {
    // Validate file type
    const validTypes = ['image/png', 'image/jpeg', 'image/jpg'];
    if (!validTypes.includes(file.type)) {
      alert('Please upload a valid PNG, JPG, or JPEG file');
      return;
    }

    // Validate file size (5MB max)
    const maxSize = 5 * 1024 * 1024; // 5MB in bytes
    if (file.size > maxSize) {
      alert('File size must be less than 5MB');
      return;
    }

    // Display file info
    fileNameEdit.textContent = file.name;
    fileSizeEdit.textContent = formatFileSize(file.size);

    // Preview image
    const reader = new FileReader();
    reader.onload = (e) => {
      previewImageEdit.src = e.target.result;
      filePreviewEdit.style.display = 'flex';
    };
    reader.readAsDataURL(file);
  }

  // Remove File
  function removeFileEdit() {
    fileInputEdit.value = '';
    filePreviewEdit.style.display = 'none';
    previewImageEdit.src = '';
    fileNameEdit.textContent = '';
    fileSizeEdit.textContent = '';
  }

  // Format File Size
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
</script>